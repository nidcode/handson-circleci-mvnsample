version: 2.1

orbs:
  scan: prisma_cloud/devops_security@1.0.0

jobs:
  docker-build:
    docker:
      - image: circleci/openjdk:8-jdk
    steps:
      - checkout
      
      - setup_remote_docker

      - run: 
          name: mvn package
          command: |
            cd web-app
            mvn package
      
      - run:
          name: docker build
          command: docker build -t mvnsample:build .
      
      - run:
          name: store docker image
          command: |
            mkdir -p workspace
            docker save mvnsample:build -o workspace/image.tar

      - persist_to_workspace:
          root: workspace
          paths:
            - image.tar

workflows:
  version: 2.1
  scan_image:
    jobs:
      - docker-build
      - scan/scan_image:
          requires:
            - docker-build
          context: jb_prisma
          prisma_cloud_compute_url: https://asia-northeast1.cloud.twistlock.com/anz-3051815
          prisma_cloud_compute_user: 69060ecb-3677-4596-bfa4-44eb37562aad
          prisma_cloud_compute_pass: PC_COMPUTE_PASS
          image: mvnsample:build
          image_tar: image.tar
          vulnerability_threshold: critical
          compliance_threshold: ''
          only_fixed: true
          filters:
            branches:
              only: /security\/twistlock.*/
