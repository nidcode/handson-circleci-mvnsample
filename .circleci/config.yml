version: 2.1

orbs:
  scan: prisma_cloud/devops_security@1.0.0

jobs:
  docker-build:
    docker:
      - image: circleci/openjdk:8-jdk
    steps:
      - checkout
      
      - setup_remote_docker

      - run: 
          name: mvn package
          command: |
            cd web-app
            mvn package
      
      - run:
          name: docker build
          command: docker build -t mvnsample:build .
      
      - run:
          name: store docker image
          command: |
            mkdir -p workspace
            docker save mvnsample:build -o workspace/image.tar

      - persist_to_workspace:
          root: workspace
          paths:
            - image.tar

  scan_image:
    docker:
      - image: nidstyle3/twistcli:latest
    steps:
      - setup_remote_docker
      - scan/auth
      - scan/load:
          pc_image_tar: image.tar
          pc_workspace_name: workspace
          
      - run:
          name: scan by twistcli
          command: twistcli images scan --details --address ${PC_COMPUTE_URL} --token ${AUTH_TOKEN} mvnsample:build  

workflows:
  version: 2.1
  scan_image:
    jobs:
      - docker-build
      - scan_image:
          requires:
            - docker-build
          context: jb_prisma
          filters:
            branches:
              only: /security\/twistlock.*
